<style>

  body {
    --max-width-text-area: calc(300px - 2em);
    --max-height-text-area: calc(300px - 2em);
  }

  textarea {
    width: var(--max-width-text-area);
    max-width: var(--max-width-text-area);
    min-width: var(--max-width-text-area);
    height: var(--max-height-text-area);
    max-height: var(--max-height-text-area);
    min-height: var(--max-height-text-area);
    padding: 1em;
  }

  .row {
    display: flex;
    flex-direction: row;
  }

  .space-between {
    justify-content: space-between;
  } 
  
  .center-align {
    align-items: center;
  } 

  .col {
    display: flex;
    flex-direction: column;
  }

  .gap1 {
    gap: 1em;
  }

  .gap_5 {
    gap: .5em;
  }

  .stickTop {
    position: sticky;
    width: 100%;
    background: #fff;
    top: 0;
    border-bottom: 1px solid #000;
  }

  .stickTop button {
    height: fit-content;
    width: fit-content;
  }

  form {
    padding-top: 1em;
  }

</style>


<script>
  const createRandomString = (size=100) => {
    let letters = ['a', ' ', 'b', 'c',  'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', ' ', 'o', 'p', 'q', 'r', 's', 't', 'u', ' ', 'v', 'w', 'x', ' ', 'y', 'z'];
    let characters = [];
    for (let k = 0; k < size; k++) {
        let nextChar = Math.floor(Math.random()*(letters.length-1));
        characters.push(letters[nextChar]);
    }
    return characters.join('')
  }

  const roundDecimalNumber = (value, decimalPoints) => {
      if(!Number.isInteger(decimalPoints)) return value;
      let multiplier = 1;
      while(decimalPoints>0) {
          multiplier *= 10;
          decimalPoints--;
      }
      return Math.round(value * multiplier) / multiplier;
  }

  const createRandomNumber = (min, max, type, unit, round) => {
      let number = min + (Math.random()*max);
      if (type==='decimal') return (round !== undefined ? roundDecimalNumber(number, round) : number) + (unit ? unit : '');
      return Math.floor(number) + (unit ? unit : '');
  }

  const createRandomDate = (dateFormat='date', language='en-GB') => {

      /*
          resources: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date
                    https://stackoverflow.com/questions/3552461/how-do-i-format-a-date-in-javascript
      */

      let today = new Date();
      let numericalFormat = today/1000;
      let lowerBound = numericalFormat - 100;
      let upperBound = numericalFormat + 100;
      let randomised = createRandomNumber(lowerBound, upperBound);
      let randomDate = new Date(randomised*1000);

      switch (dateFormat){
          case 'date':
              return randomDate.toLocaleDateString(language);
          case 'time':
              return randomDate.toLocaleTimeString(language); 
          case 'date-time':
              return randomDate.toLocaleString(language, { timeZone: 'UTC' });
          case 'speakable':
              let options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
              return randomDate.toLocaleDateString(language, options);                      
          default: 
              return randomised;
      }

      // return randomDate.toLocaleDateString(language); // 9/17/2016 (date)
      // return randomDate.toLocaleTimeString(language); // 6:17:29 PM (time)
      // return randomDate.toLocaleDateString(language, options); // Thursday, 7 August 2031 (speakable)
      // return randomDate.toLocaleString(language, { timeZone: 'UTC' }); // 17/08/2073, 08:50:30 (date-time)

  }

  const createRandomBoolean = (format='yes/no') => {
      let value = Math.random();
      let targetIndex = 0;
      if (value > .5) 
          targetIndex = 1;

      let options = format.split('/');
      if (options.length===2) {
          return options[targetIndex];
      }else {
          return "false"
      }
  }
</script>

<script>

  let stylingOpts = {
    padding: {value:0, type:'number', min:0},
    width: {value:-1, type:'number', min:-1},
    height: {value:-1, type:'number', min:-1},
    // strokes: {value:[{ type: 'SOLID', color: mode==='cond' ? cond.s : mode==='pill' ? pill.s : obl.s }], type:'figma-colour'},
    strokes: {value:[], type:'figma-colour'},
    strokeWeight:{value:1, type:'number', min:0},
    fills: {value:[], type:'figma-colour'},
    fieldFills: {value:[{ type: 'SOLID', color: {r:1, g:0, b:0} }], type:'figma-colour'},
    addFields: {value:true, type:'boolean', defaultVisibility:'flex' },
    cornerRadius: {value:[0, 0, 0, 0], type:'number-option-4', min:0 },
    fontSize: {value:12, type:'number', min:1 },
    roundDecimals: {value:3, type:'number', min:0 },
    unit: {value:" Degrees", type:'string' },
    dataType: {value:'date', type:'select-options', options:['string', 'integer', 'decimal', 'date', 'boolean']},
    dateFormat: {value:'time', type:'select-options', options:['date-time', 'date', 'time', 'timestamp', 'speakable']},
    language: {value:'en-US', type:'select-options', options:['en-GB', 'en-US']},
    booleanFormat: {value:'yes/no', type:'select-options', options:['yes/no', 'true/false']},
    minRandomValue:{value:0, type:'number'},
    maxRandomValue:{value:100, type:'number'},
    textStyling: {value:[], type:'font', min:1 },
    // {type:'font', value:{ family: "Roboto", style: "Regular" }}
  }

  let containerStylingOpts = {
    padding: {value:0, type:'number', min:0},
    gap: {value:10, type:'number', min:0},
    width: {value:-1, type:'number', min:-1},
    strokes: {value:[], type:'figma-colour'},
    strokeWeight:{value:0, type:'number', min:0, max:3},
    fills: {value:[], type:'figma-colour'},
    cornerRadius: {value:[0, 0, 0, 0], type:'number-option-4', min:0 },
    align: {value:'vertical', type:'select-options', options:['vertical', 'horizontal', 'zigzag', 'diagonal']},
  }

  let blockStylingOpts = {
    gap:{value:10, type:'number', defaultVisibility:'flex' },
    produceOne: {value:false, type:'boolean', hideItem:'*', hideOn:true, defaultVisibility:'flex' },
    quantity: { value:10, type:'number', min:1, defaultVisibility:'flex' },
    randomValues: { value:true, type:'boolean', defaultVisibility:'flex' },
    displayAsGrid: { value:false, type:'boolean', hideItem:['gridTemplateColumns', 'gridTemplateRows'], hideOn:false, defaultVisibility:'flex' },
    gridTemplateColumns: { value:1, type:'number', defaultVisibility:'none' },
    gridTemplateRows: { value:1, type:'number', defaultVisibility:'none' },
    displayAsFlex: { value:true, type:'boolean', hideItem:['flexRow', 'flexColumn'], hideOn:false, defaultVisibility:'flex' },
    flexRow: { value:false, type:'boolean' },
    flexColumn: { value:true, type:'boolean', defaultVisibility:'flex' },
    matchAllWidths: { value:true, type:'boolean', defaultVisibility:'flex' },
    matchAllHeights: { value:true, type:'boolean', defaultVisibility:'flex' },
    startFromX: { value:100, type:'number', defaultVisibility:'flex' },
    startFromY: { value:100, type:'number', defaultVisibility:'flex' },
  }



  const convertObjectIntoCollectionArr = (obj, meta={}) => 
    Object.keys(obj).map(key=> Object.assign(
        { type:'text', value:obj[key], key }, 
        meta.hasOwnProperty(key) ? meta[key] : {} 
    ))

  

  const produceKeyForm = (object, stylingOptions) => {
    let duplicateObj = {  };
    for (let k in object) {
      duplicateObj[k] = JSON.parse(JSON.stringify(stylingOptions));
    }
    return duplicateObj
  }




  const convertHexToFigmaRGB = (hex) => {
    // https://stackoverflow.com/questions/58184508/html5-input-type-color-read-single-rgb-values
    const r = parseInt(hex.substr(1,2), 16)
    const g = parseInt(hex.substr(3,2), 16)
    const b = parseInt(hex.substr(5,2), 16)
    return [{type:'SOLID', color:{ r:r/255, g:g/255, b:b/255 }}]
  }
  
  const produceInputFields = (fields, form, parentField, manageClassData=false) => {
    const root = document.documentElement;
    Object.keys(fields).forEach(key=>{
      let { value, type, max, min, hideItem, hideOn, defaultVisibility } = fields[key];
      let container = document.createElement('div');
      container.className = 'row gap1 space-between'
      let label = document.createElement('label')
      label.innerText = key;
      container.appendChild(label);

      if (manageClassData) {
        let viewProperty = `--figma-design-generator-var-${key}`
        root.style.setProperty(viewProperty, defaultVisibility !== undefined ? defaultVisibility : 'flex');
        container.style.display = `var(${viewProperty})`
      }

      if (type==='number') {
        let inputField = document.createElement('input');
        inputField.type = 'number';
        inputField.value = value;
        if (max!==undefined) inputField.max = max;
        if (min!==undefined) inputField.min = min;
        inputField.onchange = (e)=>{
            fields[key].value = parseInt(e.target.value);
        };
        container.appendChild(inputField);
      }else if (type==='figma-colour') {

        let inputField = document.createElement('input');
        inputField.type = 'color';
        inputField.value = value;

        inputField.onchange = (e)=>{
          fields[key].value = convertHexToFigmaRGB(e.target.value);
        };

        container.appendChild(inputField);
      
      }
      else if (type==='boolean') {
        let selectBlock = document.createElement('select');
        let trueOpt = document.createElement('option');
        let falseOpt = document.createElement('option');
        trueOpt.innerText = "Yes";
        falseOpt.innerText = "No";
        selectBlock.appendChild(trueOpt);
        selectBlock.appendChild(falseOpt);
        selectBlock.value = fields[key].value ? 'Yes' : 'No';
        selectBlock.onchange = (e)=>{
            fields[key].value = e.target.value === 'Yes' ? true : false;
            // hideItem, hideOn
            if (manageClassData && hideItem!==undefined) {
                let fieldsFound = [];
                let valueToSet = fields[key].value===hideOn ? 'none' : 'flex';
                fieldsFound = hideItem==='*' ? Object.keys(fields).filter(key_=>key_!==key) : hideItem;
                fieldsFound.forEach(f=>{
                  root.style.setProperty(`--figma-design-generator-var-${f}`, valueToSet);
                })
            }
        };
        container.appendChild(selectBlock);
      }
      else if (/^number-option-(\d+)$/.test(type)) {

        let miniParent = document.createElement('div');
        miniParent.className = 'row'
        for (let k = 0; k < value.length; k++) {
          let inputField = document.createElement('input');
          inputField.type = 'number';
          inputField.value = value[k];
          inputField.onchange = (e)=>{
            fields[key].value[k] = parseInt(e.target.value);
          };
          inputField.style.width = '40px'
          if (min!==undefined) {
            inputField.min = min;
          }
          if (max!==undefined) {
            inputField.min = min;
          }          
          miniParent.appendChild(inputField);
        }

        container.appendChild(miniParent);

      }

      form.appendChild(container)
    })
  }

  const produceTemplateBlock = (styleForm, manageClassData=false) => {

    Object.keys(styleForm).forEach((item, i)=>{

      let parent = document.createElement('div');
      parent.style.position = 'relative';
      let header = document.createElement('h3');

      let miniNav = document.createElement('div');
      miniNav.className = 'row'
      miniNav.appendChild(header);
      miniNav.className = 'stickTop row gap1 center-align'

      header.innerHTML = item;
      header.style.width = '100%';
      parent.appendChild(miniNav);

      let form = document.createElement('form');
      form.className = 'dynamic-form col gap_5'

      let toggleButton = document.createElement('button');
      toggleButton.innerText = "Hide"
      toggleButton.onclick = () => {
        form.style.display = !form.style.display.length || form.style.display === 'flex' ? 'none' : 'flex'
      }

      miniNav.appendChild(toggleButton);


      parent.appendChild(form);

      // styleForm[item] = { ...styleForm[item] }

      produceInputFields(styleForm[item], form, item, manageClassData);

      document.getElementById('main').append(parent);


    })
  }

  const grabValueField = (item) => {
    let newItem = JSON.parse(JSON.stringify(item))
    Object.keys(newItem).forEach((it)=>{
      let properties = newItem[it];
      Object.keys(properties).forEach((prop)=>{
        properties[prop] = properties[prop].value;
      })
    });
    return newItem;
  }

  const checkDimensionOptions = (styling, containerOptions) => {


      if (containerOptions.container.width > -1){

        Object.keys(styling).forEach(id=>{
          styling[id].width = containerOptions.container.width;
        })
      }
      
      if (containerOptions.container.height > -1){
        Object.keys(styling).forEach(id=>{
          styling[id].height = containerOptions.container.height;
        })
      }

  }



  const randomiseValues = (schema, fieldStyling, blockOptions) => {
    // fields -> create N versions with random values
    let numberToCreate = blockOptions.block.quantity;
    let newItems = [];

    for (let k = 0; k < numberToCreate; k++) {
        let newVersion = JSON.parse(JSON.stringify(schema));
        Object.keys(newVersion).forEach(field=>{
            let dataType = fieldStyling[field].dataType;
            let value = newVersion[field]

            // 'string', 'integer', 'decimal', 'date', 'boolean'              
            if (dataType==='string') {
                newVersion[field] = createRandomString(value.length*Math.floor(value.length+(Math.random()*1.5)));
            }else if (dataType==='date') {
                newVersion[field] = createRandomDate(fieldStyling[field].dateFormat, fieldStyling[field].language)
            }else if (dataType==='boolean') {
                newVersion[field] = createRandomBoolean(fieldStyling[field].booleanFormat)
            }else {
              newVersion[field] = createRandomNumber(
                fieldStyling[field].minRandomValue,
                fieldStyling[field].maxRandomValue,
                dataType,
                fieldStyling[field].unit, 
                fieldStyling[field].roundDecimals, 
              );
            }


            if (fieldStyling[field].addFields) {
              let tag = field+": ";
              newVersion[field] = tag+newVersion[field];
              if (fieldStyling[field].fieldFills.length) {
                
                fieldStyling[field].textStyling.push({type:'fill', range:[0, tag.length], value:fieldStyling[field].fieldFills });
              }
            }
        })        
        newItems.push(newVersion)
    }

    return newItems;
    
  } 

  const unifyUserInput = (userFields, fieldStyling, containerStyling, blockOptions, allBlocks) => {

    if (!Array.isArray(userFields)) {
      userFields = [userFields];
    } 

    let containerStylingValue = grabValueField(containerStyling);
    let grabbedStyling = grabValueField({...fieldStyling});
    userFields = randomiseValues(userFields[0], grabbedStyling, grabValueField({...blockOptions}));
    let blocks = userFields.map(fields=>
      {
          let newStyling = JSON.parse(JSON.stringify(grabbedStyling));
          checkDimensionOptions(newStyling, containerStylingValue);
          return {contents: convertObjectIntoCollectionArr(fields, newStyling)}
      }
    )

    let outputData = {
      blocks,
      ...containerStylingValue.container,
    }

    parent.postMessage({ pluginMessage: { type: 'create-block', value:outputData } }, '*')

  }

</script>

<div class="stickTop row gap1">
  <button id="create">Create</button>
  <button id="cancel">Cancel</button>
</div>

<div id="main">
  <h2>Enter JSON template below</h2>
  <textarea id="json" value="5"></textarea>
  <p></p>
</div>



<script>

document.getElementById('json').value = 
`
{
  "name":"My name is Momodou!",
  "age":"3232",
  "message": "Hello world, how is it going?",
  "another": "Hello world, how is it going?",
  "another2": "Hello world, how is it going?",
  "another3": "short",
  "another3": "lorem ipsum something garbage and yes thats all good!"
}
`

// {
//   "name":"My name is John!",
//   "age":"3232",
//   "message": "Hello world, how is it going?",
//   "another": "Hello world, how is it going?",
//   "another2": "Hello world, how is it going?",
//   "another3": "short",
//   "another3": "lorem ipsum something garbage and yes thats all good!"
// }



document.getElementById('create').onclick = () => {
    
  const textbox = document.getElementById('json');

  if (!textbox.value) {
    alert("nothing to do here!")
    return;
  }

  let stepOneData = JSON.parse(textbox.value);
  let allComponents = Array.isArray(stepOneData) ? [...stepOneData] : [{...stepOneData}];
  if (Array.isArray(stepOneData)) {
    stepOneData = stepOneData[0];
  }

  let keyForm = produceKeyForm(stepOneData, stylingOpts)
  let containerKeyForm = produceKeyForm({ container:null }, containerStylingOpts);
  let blockKeyForm = produceKeyForm({ block:null }, blockStylingOpts);
  // document.getElementById('create').onclick = () => extractInputs(keyForm)
  document.getElementById('create').innerText = "Manage container"
  document.getElementById('create').onclick = () => {

    document.getElementById('main').innerHTML = ""
    produceTemplateBlock(containerKeyForm);
    document.getElementById('create').innerText = "Manage Blocks"

    document.getElementById('create').onclick = () => {
        document.getElementById('create').innerText = "Generate Items"
        document.getElementById('main').innerHTML = ""
        produceTemplateBlock(blockKeyForm, true);

        document.getElementById('create').onclick = () => {

            // document.getElementById('create').innerText = "Generate Items"
            // document.getElementById('main').innerHTML = ""
            unifyUserInput(allComponents, keyForm, containerKeyForm, blockKeyForm);

        }
          
        // unifyUserInput

    }
  
  }

  document.getElementById('main').innerHTML = ""
  produceTemplateBlock(keyForm);


}

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
}
</script>

